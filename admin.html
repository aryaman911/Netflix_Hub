<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieHub - Admin</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">MOVIEHUB</div>
        <div class="nav-links">
            <a href="home.html" class="nav-link">Home</a>
            <a href="admin.html" class="nav-link active">Admin</a>
        </div>
        <div class="nav-user">
            <span class="nav-username" id="nav-username">Admin</span>
            <button class="btn btn-outline btn-small" onclick="logout()">Logout</button>
        </div>
    </nav>

    <main class="admin-container">
        <h1>Admin Panel</h1>

        <div class="admin-grid">
            <section class="admin-section">
                <h2 id="form-title">Add New Series</h2>
                <form id="series-form" onsubmit="saveSeries(event)">
                    <input type="hidden" id="series-id">
                    
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="series-name" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Language *</label>
                            <select id="series-language" required>
                                <option value="">Select</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Origin Country *</label>
                            <input type="text" id="series-country" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Release Date *</label>
                            <input type="date" id="series-release" required>
                        </div>
                        <div class="form-group">
                            <label>Episodes</label>
                            <input type="number" id="series-episodes" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Genre</label>
                            <select id="series-genre">
                                <option value="">Select</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Maturity Rating</label>
                            <select id="series-maturity">
                                <option value="">Select</option>
                                <option value="G">G</option>
                                <option value="PG">PG</option>
                                <option value="PG-13">PG-13</option>
                                <option value="R">R</option>
                                <option value="TV-MA">TV-MA</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="series-description" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Poster URL</label>
                        <input type="url" id="series-poster">
                    </div>

                    <div class="form-group">
                        <label>Banner URL</label>
                        <input type="url" id="series-banner">
                    </div>

                    <div id="form-error" class="form-error"></div>

                    <div style="display:flex; gap:1rem; margin-top:1rem;">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                    </div>
                </form>
            </section>

            <section class="admin-section">
                <h2>All Series</h2>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="series-table"></tbody>
                </table>
            </section>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check login and admin
        if (!isLoggedIn()) {
            window.location.href = 'index.html';
        }
        if (!isAdmin()) {
            showToast('Admin access required', 'error');
            window.location.href = 'home.html';
        }

        document.getElementById('nav-username').textContent = getUsername();

        loadDropdowns();
        loadSeriesList();

        async function loadDropdowns() {
            try {
                var genres = await apiRequest('/reference/genres');
                var languages = await apiRequest('/reference/languages');

                var genreSelect = document.getElementById('series-genre');
                genres.forEach(function(g) {
                    genreSelect.innerHTML += '<option value="' + g.type_code + '">' + g.type_name + '</option>';
                });

                var langSelect = document.getElementById('series-language');
                languages.forEach(function(l) {
                    langSelect.innerHTML += '<option value="' + l.language_code + '">' + l.language_name + '</option>';
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function loadSeriesList() {
            var tbody = document.getElementById('series-table');
            try {
                var series = await apiRequest('/series');
                
                if (!series.length) {
                    tbody.innerHTML = '<tr><td colspan="3">No series found</td></tr>';
                    return;
                }

                tbody.innerHTML = series.map(function(s) {
                    return '<tr>' +
                        '<td>' + s.series_id + '</td>' +
                        '<td>' + s.name + '</td>' +
                        '<td>' +
                            '<button class="btn btn-small" onclick="editSeries(' + s.series_id + ')">Edit</button> ' +
                            '<button class="btn btn-small btn-danger" onclick="deleteSeries(' + s.series_id + ')">Delete</button>' +
                        '</td>' +
                    '</tr>';
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="3">Error loading series</td></tr>';
            }
        }

        async function editSeries(id) {
            try {
                var s = await apiRequest('/series/' + id);
                
                document.getElementById('series-id').value = s.series_id;
                document.getElementById('series-name').value = s.name || '';
                document.getElementById('series-language').value = s.language_code || '';
                document.getElementById('series-country').value = s.origin_country || '';
                document.getElementById('series-release').value = s.release_date || '';
                document.getElementById('series-episodes').value = s.num_episodes || 0;
                document.getElementById('series-maturity').value = s.maturity_rating || '';
                document.getElementById('series-description').value = s.description || '';
                document.getElementById('series-poster').value = s.poster_url || '';
                document.getElementById('series-banner').value = s.banner_url || '';

                document.getElementById('form-title').textContent = 'Edit Series';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function deleteSeries(id) {
            if (!confirm('Delete this series?')) return;

            try {
                await apiRequest('/series/' + id, { method: 'DELETE' });
                showToast('Deleted', 'success');
                loadSeriesList();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        function resetForm() {
            document.getElementById('series-id').value = '';
            document.getElementById('series-form').reset();
            document.getElementById('form-title').textContent = 'Add New Series';
            document.getElementById('form-error').textContent = '';
        }

        async function saveSeries(e) {
            e.preventDefault();
            var errorEl = document.getElementById('form-error');
            errorEl.textContent = '';

            var id = document.getElementById('series-id').value;
            var genre = document.getElementById('series-genre').value;

            var payload = {
                name: document.getElementById('series-name').value.trim(),
                language_code: document.getElementById('series-language').value,
                origin_country: document.getElementById('series-country').value.trim(),
                release_date: document.getElementById('series-release').value,
                num_episodes: parseInt(document.getElementById('series-episodes').value) || 0,
                maturity_rating: document.getElementById('series-maturity').value || null,
                description: document.getElementById('series-description').value.trim() || null,
                poster_url: document.getElementById('series-poster').value.trim() || null,
                banner_url: document.getElementById('series-banner').value.trim() || null,
                genre_codes: genre ? [genre] : [],
            };

            try {
                if (id) {
                    await apiRequest('/series/' + id, { method: 'PUT', body: JSON.stringify(payload) });
                    showToast('Updated!', 'success');
                } else {
                    await apiRequest('/series', { method: 'POST', body: JSON.stringify(payload) });
                    showToast('Created!', 'success');
                }
                resetForm();
                loadSeriesList();
            } catch (err) {
                errorEl.textContent = err.message;
            }
        }
    </script>
</body>
</html>
