<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Netflix Hub - Admin</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar solid">
    <div class="logo">MOVIEHUB</div>
    <div class="nav-links">
      <a href="home.html" class="nav-link">Home</a>
      <a href="watchlist.html" class="nav-link">My List</a>
      <a href="admin.html" class="nav-link active">Admin</a>
    </div>
    <div class="nav-user">
      <span class="nav-username" id="nav-username">Admin</span>
      <button class="btn btn-outline btn-small" id="btn-logout">Logout</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="admin-container">
    <h1>Admin Panel</h1>

    <div class="admin-grid">
      <!-- Form Section -->
      <section class="admin-form-section">
        <h2>Add / Edit Series</h2>
        <form id="series-form">
          <input type="hidden" id="series-id">
          
          <div class="form-group">
            <label for="series-name">Name *</label>
            <input type="text" id="series-name" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="series-language">Language *</label>
              <select id="series-language" required>
                <option value="">Select Language</option>
              </select>
            </div>
            <div class="form-group">
              <label for="series-country">Origin Country *</label>
              <input type="text" id="series-country" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="series-release">Release Date *</label>
              <input type="date" id="series-release" required>
            </div>
            <div class="form-group">
              <label for="series-episodes">Number of Episodes</label>
              <input type="number" id="series-episodes" min="0" value="0">
            </div>
          </div>

          <div class="form-group">
            <label for="series-genre">Genre</label>
            <select id="series-genre">
              <option value="">Select Genre</option>
            </select>
          </div>

          <div class="form-group">
            <label for="series-maturity">Maturity Rating</label>
            <select id="series-maturity">
              <option value="">Select Rating</option>
              <option value="G">G - General</option>
              <option value="PG">PG - Parental Guidance</option>
              <option value="PG-13">PG-13</option>
              <option value="R">R - Restricted</option>
              <option value="NC-17">NC-17</option>
              <option value="TV-MA">TV-MA</option>
            </select>
          </div>

          <div class="form-group">
            <label for="series-description">Description</label>
            <textarea id="series-description" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="series-poster">Poster URL</label>
            <input type="url" id="series-poster" placeholder="https://...">
          </div>

          <div class="form-group">
            <label for="series-banner">Banner URL</label>
            <input type="url" id="series-banner" placeholder="https://...">
          </div>

          <div id="form-error" class="form-error"></div>

          <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button type="submit" class="btn btn-primary">Save Series</button>
            <button type="button" class="btn btn-secondary" id="btn-reset">Reset Form</button>
          </div>
        </form>
      </section>

      <!-- List Section -->
      <section class="admin-list-section">
        <h2>All Series</h2>
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Country</th>
              <th>Language</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="series-table-body">
            <tr><td colspan="5" class="loading">Loading...</td></tr>
          </tbody>
        </table>
      </section>
    </div>
  </main>

  <script type="module">
    import { requireAdmin, logout, getUsername } from './js/auth.js';
    import { apiRequest, showToast } from './js/api.js';

    // Require admin
    if (!requireAdmin()) {
      throw new Error('Not authorized');
    }

    // Set username
    document.getElementById('nav-username').textContent = getUsername();

    // Logout button
    document.getElementById('btn-logout').addEventListener('click', logout);

    const form = document.getElementById('series-form');
    const tableBody = document.getElementById('series-table-body');
    const errorEl = document.getElementById('form-error');

    // Load genres and languages for dropdowns
    async function loadDropdowns() {
      try {
        const [genres, languages] = await Promise.all([
          apiRequest('/reference/genres'),
          apiRequest('/reference/languages'),
        ]);

        const genreSelect = document.getElementById('series-genre');
        genres.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.type_code;
          opt.textContent = g.type_name;
          genreSelect.appendChild(opt);
        });

        const langSelect = document.getElementById('series-language');
        languages.forEach(l => {
          const opt = document.createElement('option');
          opt.value = l.language_code;
          opt.textContent = l.language_name;
          langSelect.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load dropdowns:', err);
      }
    }

    // Load series list
    async function loadSeries() {
      try {
        const series = await apiRequest('/series');
        
        if (!series.length) {
          tableBody.innerHTML = '<tr><td colspan="5">No series yet</td></tr>';
          return;
        }

        tableBody.innerHTML = series.map(s => `
          <tr>
            <td>${s.series_id}</td>
            <td>${s.name}</td>
            <td>${s.origin_country || '-'}</td>
            <td>${s.language_code || '-'}</td>
            <td>
              <button class="btn btn-small" data-edit="${s.series_id}">Edit</button>
              <button class="btn btn-small btn-danger" data-delete="${s.series_id}">Delete</button>
            </td>
          </tr>
        `).join('');

        // Edit buttons
        tableBody.querySelectorAll('[data-edit]').forEach(btn => {
          btn.addEventListener('click', () => loadSeriesForEdit(btn.dataset.edit));
        });

        // Delete buttons
        tableBody.querySelectorAll('[data-delete]').forEach(btn => {
          btn.addEventListener('click', () => deleteSeries(btn.dataset.delete));
        });

      } catch (err) {
        tableBody.innerHTML = `<tr><td colspan="5">Error: ${err.message}</td></tr>`;
      }
    }

    // Load series into form for editing
    async function loadSeriesForEdit(id) {
      try {
        const s = await apiRequest(`/series/${id}`);
        
        document.getElementById('series-id').value = s.series_id;
        document.getElementById('series-name').value = s.name || '';
        document.getElementById('series-language').value = s.language_code || '';
        document.getElementById('series-country').value = s.origin_country || '';
        document.getElementById('series-release').value = s.release_date || '';
        document.getElementById('series-episodes').value = s.num_episodes || 0;
        document.getElementById('series-genre').value = s.genres?.[0] || '';
        document.getElementById('series-maturity').value = s.maturity_rating || '';
        document.getElementById('series-description').value = s.description || '';
        document.getElementById('series-poster').value = s.poster_url || '';
        document.getElementById('series-banner').value = s.banner_url || '';

        // Scroll to form
        document.querySelector('.admin-form-section').scrollIntoView({ behavior: 'smooth' });
        
      } catch (err) {
        showToast('Failed to load series: ' + err.message, 'error');
      }
    }

    // Delete series
    async function deleteSeries(id) {
      if (!confirm('Delete this series? This cannot be undone.')) return;

      try {
        await apiRequest(`/series/${id}`, { method: 'DELETE' });
        showToast('Series deleted', 'success');
        loadSeries();
      } catch (err) {
        showToast('Failed to delete: ' + err.message, 'error');
      }
    }

    // Reset form
    document.getElementById('btn-reset').addEventListener('click', () => {
      document.getElementById('series-id').value = '';
      form.reset();
      errorEl.textContent = '';
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorEl.textContent = '';

      const seriesId = document.getElementById('series-id').value;
      const genre = document.getElementById('series-genre').value;

      const payload = {
        name: document.getElementById('series-name').value.trim(),
        language_code: document.getElementById('series-language').value,
        origin_country: document.getElementById('series-country').value.trim(),
        release_date: document.getElementById('series-release').value,
        num_episodes: parseInt(document.getElementById('series-episodes').value) || 0,
        maturity_rating: document.getElementById('series-maturity').value || null,
        description: document.getElementById('series-description').value.trim() || null,
        poster_url: document.getElementById('series-poster').value.trim() || null,
        banner_url: document.getElementById('series-banner').value.trim() || null,
        genre_codes: genre ? [genre] : [],
      };

      try {
        if (seriesId) {
          // Update existing
          await apiRequest(`/series/${seriesId}`, {
            method: 'PUT',
            body: JSON.stringify(payload),
          });
          showToast('Series updated!', 'success');
        } else {
          // Create new
          await apiRequest('/series', {
            method: 'POST',
            body: JSON.stringify(payload),
          });
          showToast('Series created!', 'success');
        }

        document.getElementById('series-id').value = '';
        form.reset();
        loadSeries();

      } catch (err) {
        errorEl.textContent = err.message || 'Failed to save series';
      }
    });

    // Initial load
    loadDropdowns();
    loadSeries();
  </script>
</body>
</html>
