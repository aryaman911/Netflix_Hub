<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieHub - Sign In</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="auth-page">
  <nav class="navbar">
    <div class="logo">MOVIEHUB</div>
  </nav>

  <div class="auth-container">
    <div class="auth-box">
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showTab('login')">Sign In</button>
        <button class="auth-tab" onclick="showTab('signup')">Sign Up</button>
      </div>

      <!-- Login Form -->
      <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email or Username</label>
          <input type="text" id="login-username" placeholder="Enter email or username" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" placeholder="Enter password" required>
        </div>
        <div id="login-error" class="form-error"></div>
        <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">Sign In</button>
      </form>

      <!-- Signup Form -->
      <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
        <div class="signup-scroll">
          <div class="form-row">
            <div class="form-group">
              <label>First Name</label>
              <input type="text" id="signup-firstname" required>
            </div>
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" id="signup-lastname" required>
            </div>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="signup-email" required>
          </div>
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="signup-username" required>
          </div>
          <div class="form-group">
            <label>Password (min 6 characters)</label>
            <input type="password" id="signup-password" minlength="6" required>
          </div>
          <div class="form-group">
            <label>Address</label>
            <input type="text" id="signup-address" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="signup-city" required>
            </div>
            <div class="form-group">
              <label>State</label>
              <input type="text" id="signup-state" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Postal Code</label>
              <input type="text" id="signup-postal" required>
            </div>
            <div class="form-group">
              <label>Country</label>
              <select id="signup-country" required>
                <option value="">Select</option>
                <option value="US">United States</option>
                <option value="CA">Canada</option>
                <option value="GB">United Kingdom</option>
                <option value="AU">Australia</option>
                <option value="DE">Germany</option>
                <option value="FR">France</option>
                <option value="IN">India</option>
                <option value="JP">Japan</option>
              </select>
            </div>
          </div>
        </div>
        <div id="signup-error" class="form-error"></div>
        <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">Sign Up</button>
      </form>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Redirect if already logged in
    if (isLoggedIn()) {
      window.location.href = isAdmin() ? 'admin.html' : 'home.html';
    }

    function showTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      
      if (tab === 'login') {
        document.querySelectorAll('.auth-tab')[0].classList.add('active');
        document.getElementById('login-form').classList.add('active');
      } else {
        document.querySelectorAll('.auth-tab')[1].classList.add('active');
        document.getElementById('signup-form').classList.add('active');
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const errorEl = document.getElementById('login-error');
      errorEl.textContent = '';

      try {
        const data = await login(
          document.getElementById('login-username').value.trim(),
          document.getElementById('login-password').value
        );
        showToast('Login successful!', 'success');
        setTimeout(() => {
          window.location.href = (data.roles && data.roles.includes('ADMIN')) ? 'admin.html' : 'home.html';
        }, 500);
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      const errorEl = document.getElementById('signup-error');
      errorEl.textContent = '';

      const userData = {
        email: document.getElementById('signup-email').value.trim(),
        username: document.getElementById('signup-username').value.trim(),
        password: document.getElementById('signup-password').value,
        first_name: document.getElementById('signup-firstname').value.trim(),
        last_name: document.getElementById('signup-lastname').value.trim(),
        address_line1: document.getElementById('signup-address').value.trim(),
        city: document.getElementById('signup-city').value.trim(),
        state_province: document.getElementById('signup-state').value.trim(),
        postal_code: document.getElementById('signup-postal').value.trim(),
        country_code: document.getElementById('signup-country').value,
      };

      try {
        await signup(userData);
        showToast('Account created! Please sign in.', 'success');
        showTab('login');
        document.getElementById('login-username').value = userData.email;
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }
  </script>
</body>
</html>
