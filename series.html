<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieHub - Series</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .language-section {
            padding: 1.5rem 4%;
            background: var(--bg-card);
            margin: 1rem 0;
        }
        .language-section h3 {
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .language-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .lang-tag {
            background: rgba(229, 9, 20, 0.2);
            color: var(--accent);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .series-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">MOVIEHUB</div>
        <div class="nav-links">
            <a href="home.html" class="nav-link">Home</a>
            <a href="watchlist.html" class="nav-link">My List</a>
            <a href="admin.html" class="nav-link" id="nav-admin" style="display:none;">Admin</a>
        </div>
        <div class="nav-user">
            <span class="nav-username" id="nav-username">User</span>
            <button class="btn btn-outline btn-small" onclick="logout()">Logout</button>
        </div>
    </nav>

    <main class="main-content" style="padding-top:60px;">
        <div class="series-banner" id="series-banner"></div>
        
        <div class="series-info">
            <div class="series-poster">
                <img id="series-poster" src="" alt="">
            </div>
            <div class="series-details">
                <h1 id="series-title">Loading...</h1>
                <div class="series-meta" id="series-meta"></div>
                <div class="series-stats" id="series-stats"></div>
                <p class="series-description" id="series-description"></p>
                <div class="series-actions">
                    <button class="btn btn-primary" id="btn-watchlist" onclick="toggleWatchlist()">+ Add to My List</button>
                </div>
            </div>
        </div>

        <section class="language-section" id="dub-section" style="display:none;">
            <h3>Available Audio</h3>
            <div class="language-tags" id="dub-tags"></div>
        </section>

        <section class="language-section" id="sub-section" style="display:none;">
            <h3>Subtitles</h3>
            <div class="language-tags" id="sub-tags"></div>
        </section>

        <section class="rating-section">
            <h2>Ratings and Reviews</h2>
            <div class="rating-summary">
                <span class="rating-big" id="avg-rating">-</span>
                <span id="rating-count">No ratings yet</span>
            </div>
            
            <h3>Rate this series</h3>
            <div class="star-input" id="star-input"></div>
            <div class="form-group" style="max-width:500px;">
                <textarea id="review-text" placeholder="Write a review (optional)" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitRating()">Submit Rating</button>
            
            <div class="reviews-list" id="reviews-list"></div>
        </section>

        <section class="episodes-section">
            <h2 id="episodes-title">Episodes</h2>
            <div id="episodes-list"></div>
        </section>
    </main>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        if (!isLoggedIn()) {
            window.location.href = 'index.html';
        }

        if (isAdmin()) {
            document.getElementById('nav-admin').style.display = 'inline';
        }
        document.getElementById('nav-username').textContent = getUsername();

        var params = new URLSearchParams(window.location.search);
        var seriesId = params.get('id');
        if (!seriesId) window.location.href = 'home.html';

        var currentRating = 0;
        var inWatchlist = false;

        var starInput = document.getElementById('star-input');
        for (var i = 1; i <= 5; i++) {
            var star = document.createElement('span');
            star.textContent = '‚òÜ';
            star.dataset.value = i;
            star.onclick = (function(val) {
                return function() { setRating(val); };
            })(i);
            star.onmouseenter = (function(val) {
                return function() { highlightStars(val); };
            })(i);
            star.onmouseleave = function() { highlightStars(currentRating); };
            starInput.appendChild(star);
        }

        function setRating(val) {
            currentRating = val;
            highlightStars(val);
        }

        function highlightStars(val) {
            var stars = starInput.querySelectorAll('span');
            stars.forEach(function(s, i) {
                s.textContent = i < val ? '‚òÖ' : '‚òÜ';
                if (i < val) s.classList.add('active');
                else s.classList.remove('active');
            });
        }

        loadSeries();
        loadFeedback();
        checkWatchlist();

        async function loadSeries() {
            try {
                var s = await apiRequest('/series/' + seriesId);
                
                document.title = 'MovieHub - ' + s.name;
                document.getElementById('series-title').textContent = s.name;
                document.getElementById('series-description').textContent = s.description || 'No description available.';
                
                document.getElementById('series-banner').style.backgroundImage = 'url(' + (s.banner_url || s.poster_url || CONFIG.PLACEHOLDER_IMAGE) + ')';
                
                var poster = document.getElementById('series-poster');
                poster.src = s.poster_url || CONFIG.PLACEHOLDER_IMAGE;
                poster.onerror = function() { this.src = CONFIG.PLACEHOLDER_IMAGE; };
                
                var meta = '';
                if (s.release_date) meta += '<span>üìÖ ' + s.release_date + '</span>';
                if (s.maturity_rating) meta += '<span>üîû ' + s.maturity_rating + '</span>';
                if (s.origin_country) meta += '<span>üåç ' + s.origin_country + '</span>';
                if (s.genres && s.genres.length) meta += '<span>üé≠ ' + s.genres.join(', ') + '</span>';
                document.getElementById('series-meta').innerHTML = meta;

                var stats = '<div class="stat-item"><div class="stat-value">' + (s.num_episodes || 0) + '</div><div class="stat-label">Episodes</div></div>';
                stats += '<div class="stat-item"><div class="stat-value">' + (s.avg_rating ? s.avg_rating.toFixed(1) : '-') + '</div><div class="stat-label">Rating</div></div>';
                stats += '<div class="stat-item"><div class="stat-value">' + (s.rating_count || 0) + '</div><div class="stat-label">Reviews</div></div>';
                document.getElementById('series-stats').innerHTML = stats;

                if (s.dub_languages && s.dub_languages.length > 0) {
                    document.getElementById('dub-section').style.display = 'block';
                    document.getElementById('dub-tags').innerHTML = s.dub_languages.map(function(lang) {
                        return '<span class="lang-tag">' + lang + '</span>';
                    }).join('');
                }

                if (s.sub_languages && s.sub_languages.length > 0) {
                    document.getElementById('sub-section').style.display = 'block';
                    document.getElementById('sub-tags').innerHTML = s.sub_languages.map(function(lang) {
                        return '<span class="lang-tag">' + lang + '</span>';
                    }).join('');
                }
                
                var epList = document.getElementById('episodes-list');
                document.getElementById('episodes-title').textContent = 'Episodes (' + (s.episodes ? s.episodes.length : 0) + ')';
                
                if (s.episodes && s.episodes.length) {
                    epList.innerHTML = s.episodes.map(function(ep) {
                        return '<div class="episode-item">' +
                            '<div class="episode-number">' + ep.episode_number + '</div>' +
                            '<div class="episode-info">' +
                                '<h3>' + ep.title + '</h3>' +
                                '<p>' + (ep.synopsis || 'No synopsis available.') + '</p>' +
                                (ep.runtime_minutes ? '<p style="color:var(--text-secondary);font-size:0.8rem;">Runtime: ' + ep.runtime_minutes + ' min</p>' : '') +
                            '</div>' +
                        '</div>';
                    }).join('');
                } else {
                    epList.innerHTML = '<div class="empty-state">No episodes available</div>';
                }
            } catch (err) {
                showToast('Failed to load series', 'error');
            }
        }

        async function loadFeedback() {
            try {
                var data = await apiRequest('/series/' + seriesId + '/feedback');
                
                if (data.average_rating) {
                    document.getElementById('avg-rating').textContent = data.average_rating.toFixed(1);
                    document.getElementById('rating-count').textContent = data.rating_count + ' ratings';
                }
                
                var list = document.getElementById('reviews-list');
                if (data.items && data.items.length) {
                    list.innerHTML = '<h3 style="margin:1.5rem 0 1rem;">User Reviews</h3>' + data.items.map(function(r) {
                        var stars = '';
                        for (var i = 0; i < 5; i++) {
                            stars += i < r.rating ? '‚òÖ' : '‚òÜ';
                        }
                        return '<div class="review-item">' +
                            '<div class="review-header">' +
                                '<span class="review-author">' + (r.account_name || 'User') + '</span>' +
                                '<span class="review-rating">' + stars + '</span>' +
                            '</div>' +
                            (r.feedback_text ? '<p class="review-text">' + r.feedback_text + '</p>' : '') +
                            '<small style="color:var(--text-secondary);">' + r.feedback_date + '</small>' +
                        '</div>';
                    }).join('');
                } else {
                    list.innerHTML = '<div class="empty-state">No reviews yet. Be the first to review!</div>';
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function checkWatchlist() {
            try {
                var list = await apiRequest('/me/watchlist');
                inWatchlist = list.some(function(w) { return w.series_id == seriesId; });
                updateWatchlistBtn();
            } catch (err) {}
        }

        function updateWatchlistBtn() {
            var btn = document.getElementById('btn-watchlist');
            if (inWatchlist) {
                btn.textContent = '‚úì In My List';
                btn.className = 'btn btn-secondary';
            } else {
                btn.textContent = '+ Add to My List';
                btn.className = 'btn btn-primary';
            }
        }

        async function toggleWatchlist() {
            try {
                if (inWatchlist) {
                    await apiRequest('/me/watchlist/' + seriesId, { method: 'DELETE' });
                    showToast('Removed from list', 'success');
                } else {
                    await apiRequest('/me/watchlist/' + seriesId, { method: 'POST' });
                    showToast('Added to list', 'success');
                }
                inWatchlist = !inWatchlist;
                updateWatchlistBtn();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function submitRating() {
            if (currentRating === 0) {
                showToast('Please select a rating', 'error');
                return;
            }

            try {
                await apiRequest('/series/' + seriesId + '/feedback', {
                    method: 'POST',
                    body: JSON.stringify({
                        rating: currentRating,
                        feedback_text: document.getElementById('review-text').value.trim() || null
                    })
                });
                showToast('Rating submitted!', 'success');
                document.getElementById('review-text').value = '';
                currentRating = 0;
                highlightStars(0);
                loadFeedback();
                loadSeries();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }
    </script>
</body>
</html>
